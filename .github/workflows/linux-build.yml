name: 'Compile and build the packages for Linux'

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches:
      - 'main'
    tags:
      - '*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: # yamllint disable-line rule:empty-values

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  prepare:
    runs-on:
      - self-hosted
      - rhel8

    steps:

      # we use `${{ github.sha }}` so we get a (mostly) unique directory, to avoid folder collisions when multiple workflows are running
      - name: 'checkout the monitoring-plugins repo'
        uses: 'actions/checkout@v3'
        with:
          path: '${{ github.sha }}/repos/monitoring-plugins'
          # ref: ''

      - name: 'checkout the lib repo'
        uses: 'actions/checkout@v3'
        with:
          repository: 'Linuxfabrik/lib'
          # ref: ''
          path: '${{ github.sha }}/repos/lib'

      - name: 'mkdir ${{ github.sha }}/build'
        run: 'mkdir ${{ github.sha }}/build'

  build-rhel7:
    runs-on:
      - self-hosted
      - rhel7
    needs:
      - 'prepare'

    steps:

      - name: 'mkdir ${{ github.sha }}/build/rhel7'
        run: 'mkdir ${{ github.sha }}/build/rhel7'

      - name: 'Run RHEL8'
        run: |-
          podman run --interactive --rm \
          --mount type=bind,source=${{ github.sha }}/build/rhel7,destination=/build,relabel=private \
          --mount type=bind,source=${{ github.sha }}/repos,destination=/repos,relabel=shared,ro=true \
          registry.access.redhat.com/ubi8/ubi /bin/bash -x /repos/monitoring-plugins/build/rhel7/build.sh

  build-rhel8:
    runs-on:
      - self-hosted
      - rhel8
    needs:
      - 'prepare'

    steps:

      - name: 'mkdir ${{ github.sha }}/build/rhel8'
        run: 'mkdir ${{ github.sha }}/build/rhel8'

      - name: 'Run RHEL8'
        run: |-
          podman run --interactive --rm \
          --mount type=bind,source=${{ github.sha }}/build/rhel8,destination=/build,relabel=private \
          --mount type=bind,source=${{ github.sha }}/repos,destination=/repos,relabel=shared,ro=true \
          registry.access.redhat.com/ubi8/ubi /bin/bash -x /repos/monitoring-plugins/build/rhel8/build.sh

  build-rhel9:
    runs-on:
      - self-hosted
      - rhel9
    needs:
      - 'prepare'

    steps:

      - name: 'mkdir ${{ github.sha }}/build/rhel9'
        run: 'mkdir ${{ github.sha }}/build/rhel9'

      - name: 'Run RHEL8'
        run: |-
          podman run --interactive --rm \
          --mount type=bind,source=${{ github.sha }}/build/rhel9,destination=/build,relabel=private \
          --mount type=bind,source=${{ github.sha }}/repos,destination=/repos,relabel=shared,ro=true \
          registry.access.redhat.com/ubi8/ubi /bin/bash -x /repos/monitoring-plugins/build/rhel9/build.sh

  upload-outputs:
    runs-on:
      - self-hosted
      - rhel8
    needs:
      - 'build-rhel8'

    steps:
      - name: 'upload the output as monitoring-plugins-linux-packages'
        uses: 'actions/upload-artifact@v3'
        with:
          name: 'monitoring-plugins-linux-packages'
          path: '${{ github.sha }}/build/'
